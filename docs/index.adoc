ifndef::leveloffset[]
:toc: left
:toclevels: 3
endif::[]

include::header.adoc[]

== Kubernetes

=== Config

[source,console]
----
$ kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://127.0.0.1:46829
  name: kind-kind-1
contexts:
- context:
    cluster: kind-kind-1
    user: kind-kind-1
  name: kind-kind-1
current-context: kind-kind-1
kind: Config
preferences: {}
users:
- name: kind-kind-1
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED
----

[source,console]
----
$ kubectl config get-contexts
CURRENT   NAME          CLUSTER       AUTHINFO      NAMESPACE
*         kind-kind-1   kind-kind-1   kind-kind-1
----

=== Secrets

[source,yaml]
----
include::../kind/secret-ex1/busybox.yaml[]
----

[source,shell]
----
include::../kind/secret-ex1/secret-ex1.sh[]
----

.Results
* create secrets
+
[source,console]
----
$ kind/secret-ex1/secret-ex1.sh create
+ kubectl create ns secret-ex1
namespace/secret-ex1 created
+ printf 'apple\nbanana\ncherry\n'
+ kubectl create secret generic -n secret-ex1 secret-ex1 --from-file=/tmp/secret-ex1.zdON/fruits.txt
secret/secret-ex1 created
+ kubectl apply -f kind/secret-ex1/busybox.yaml -n secret-ex1
job.batch/test-job created
----

* Show results
+
[source,console]
----
$ kind/secret-ex1/secret-ex1.sh show
+ kubectl get secret -n secret-ex1 secret-ex1 -o 'jsonpath={.data['\''fruits\.txt'\'']}'
+ base64 -d
apple
banana
cherry
+ kubectl get pods -n secret-ex1
NAME             READY   STATUS      RESTARTS   AGE
test-job-xxxxx   0/1     Completed   0          6s
+ kubectl logs -n secret-ex1 test-job-xxxxx
apple
banana
cherry
----

* Delete secrets
+
[source,console]
----
$ kind/secret-ex1/secret-ex1.sh delete
+ kubectl delete -f kind/secret-ex1/busybox.yaml -n secret-ex1
job.batch "test-job" deleted
+ kubectl delete secret -n secret-ex1 secret-ex1
secret "secret-ex1" deleted
+ kubectl delete ns secret-ex1
namespace "secret-ex1" deleted
----

=== Namespace

[source,console]
----
$ kubectl get namespace
NAME                 STATUS   AGE
default              Active   31h
kube-node-lease      Active   31h
kube-public          Active   31h
kube-system          Active   31h
local-path-storage   Active   31h
metallb-system       Active   8m8s
----

=== Nodes

[source,console]
----
$ kubectl get nodes --show-labels
NAME                   STATUS   ROLES           AGE   VERSION   LABELS
kind-1-control-plane   Ready    control-plane   45d   v1.24.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=kind-1-control-plane,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node.kubernetes.io/exclude-from-external-load-balancers=
----

[source,shell]
----
kubectl get nodes kind-1-control-plane -o jsonpath="{.metadata.labels.kubernetes\.io/hostname}"
----

.References
* https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/[Assign Pods to Nodes | Kubernetes^]

=== Deployments

* Deploymentに関する情報を表示します:
+
[source,console]
----
$ kubectl get deployments go-hello-app
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
go-hello-app   1/1     1            1           9h
----
+
[source,console]
----
$ kubectl describe deployments go-hello-app
----

* Delete deployment
+
[source,console]
----
$ kubectl delete deployment go-hello-app
----

=== Pods

[source,console]
----
$ kubectl get pods --all-namespaces
NAMESPACE            NAME                                         READY   STATUS    RESTARTS     AGE
default              go-hello-app-6cf496f84c-5j62s                1/1     Running   1 (8h ago)   22h
kube-system          coredns-6d4b75cb6d-aaaaa                     1/1     Running   2 (8h ago)   31h
kube-system          coredns-6d4b75cb6d-x6s88                     1/1     Running   2 (8h ago)   31h
kube-system          etcd-kind-control-plane                      1/1     Running   2 (8h ago)   31h
kube-system          kindnet-bbbbb                                1/1     Running   2 (8h ago)   31h
kube-system          kube-apiserver-kind-control-plane            1/1     Running   2 (8h ago)   31h
kube-system          kube-controller-manager-kind-control-plane   1/1     Running   2 (8h ago)   31h
kube-system          kube-proxy-ccccc                             1/1     Running   2 (8h ago)   31h
kube-system          kube-scheduler-kind-control-plane            1/1     Running   2 (8h ago)   31h
local-path-storage   local-path-provisioner-9cd9bd544-ddddd       1/1     Running   4 (8h ago)   31h
metallb-system       controller-5bd9496b89-eeeee                  1/1     Running   0            6m36s
metallb-system       speaker-fffff                                1/1     Running   0            6m37s
----

* Get Pod IP's
+
[source,shell]
----
kubectl get pod go-hello-pod -o jsonpath='{.status.podIP}'
----
+
[source,console]
----
$ kubectl get pods -l app=go-hello-app -o custom-columns=POD_IP:.status.podIPs
POD_IP
[map[ip:10.244.0.12]]
[map[ip:10.244.0.13]]
----

* Get container ports
+
[source,shell]
----
kubectl get pods -l app=go-hello-app -o jsonpath='{.items[0].spec.containers[0].ports[0].containerPort}' | python3 -m json.tool
----
+
[source,console]
----
$ kubectl get pods -l app=go-hello-app -o custom-columns="Pod IP":.status.podIP,"Container port":.spec.containers[0].ports[].containerPort
Pod IP        Container port
10.244.0.12   8080
10.244.0.13   8080
----

* Add curl images
+
[source,shell]
----
kubectl run -n default -it curl --image=curlimages/curl --rm --restart=Never -- /bin/sh
----
+
* https://hub.docker.com/r/curlimages/curl[curlimages/curl - Docker Image | Docker Hub^]

.References
* https://kubernetes.io/docs/tasks/inject-data-application/_print/[Inject Data Into Applications | Kubernetes^] +
  kubernetes args dynamic pod ip - Google Search
* https://stackoverflow.com/questions/50248525/is-there-a-way-to-put-kubernetes-secret-value-in-args-field-of-yaml-file[Is there a way to put Kubernetes secret value in args field of yaml file - Stack Overflow^] +
  kubernetes args valueFrom - Google 検索

=== ReplicaSets

* ReplicaSetオブジェクトに関する情報を表示します:
+
[source,console]
----
$ kubectl get replicasets
NAME                      DESIRED   CURRENT   READY   AGE
go-hello-app-54877bc7f9   0         0         0       9h
go-hello-app-6cf496f84c   1         1         1       28m
go-hello-app-854775f8d4   0         0         0       9h
----
+
[source,console]
----
$ kubectl describe replicasets
----

=== Services

* Serviceに関する情報を表示します:
+
[source,console]
----
$ kubectl get services
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   9h
----

** Get details
+
[source,shell]
----
kubectl get services go-hello-pod-metallb -o json | python3 -m json.tool
----

** Get external ip
+
[source,shell]
----
kubectl get services go-hello-pod-metallb -o jsonpath='{.status.loadBalancer.ingress[*].ip}'
----

** Get a port
+
[source,shell]
----
kubectl get services go-hello-service -o jsonpath='{.spec.ports[0].port}'
----

* Delete service
+
[source,console]
----
$ kubectl delete services my-service
----

=== Endpoints

* Show all endpoints
+
[source,console]
----
$ kubectl get endpoints --all-namespaces
NAMESPACE        NAME                   ENDPOINTS                                               AGE
default          go-hello-pod-metallb   <none>                                                  5m36s
default          kubernetes             172.18.0.2:6443                                         37m
kube-system      kube-dns               10.244.0.2:53,10.244.0.3:53,10.244.0.2:53 + 3 more...   37m
metallb-system   webhook-service        10.244.0.5:9443                                         36m
----

* Get endpoints
+
[source,console]
----
kubectl get endpoints go-hello-service -o json
----
+
[source,json]
----
{
    "apiVersion": "v1",
    "kind": "Endpoints",
    "metadata": {
        "annotations": {
            "endpoints.kubernetes.io/last-change-trigger-time": "2022-08-27T23:57:09Z"
        },
        "creationTimestamp": "2022-08-27T23:57:07Z",
        "name": "go-hello-service",
        "namespace": "default",
        "resourceVersion": "14624",
        "uid": "9dbcd5ca-abd8-46a5-9ebd-aa91f7c99b59"
    },
    "subsets": [
        {
            "addresses": [
                {
                    "ip": "10.244.0.8",
                    "nodeName": "kind-1-control-plane",
                    "targetRef": {
                        "kind": "Pod",
                        "name": "go-hello-app-6cf496f84c-bq4rp",
                        "namespace": "default",
                        "uid": "16eb41f9-6f72-4438-ba0a-32cb83c603d5"
                    }
                }
            ],
            "ports": [
                {
                    "name": "http",
                    "port": 8080,
                    "protocol": "TCP"
                }
            ]
        }
    ]
}
----

* Describe endpoints
+
[source,console]
----
$ kubectl describe endpoints go-hello-service
Name:         go-hello-service
Namespace:    default
Labels:       <none>
Annotations:  endpoints.kubernetes.io/last-change-trigger-time: 2022-08-27T23:57:09Z
Subsets:
  Addresses:          10.244.0.8
  NotReadyAddresses:  <none>
  Ports:
    Name  Port  Protocol
    ----  ----  --------
    http  8080  TCP

Events:  <none>
----

=== Storage

==== emptyDir

[source,yaml]
.kind/ex-storage-empty-dir.yaml
----
include::../kind/ex-storage-empty-dir.yaml[]
----

[source,shell]
----
kubectl apply -f kind/ex-storage-empty-dir.yaml
----

[source,console]
----
$ kubectl exec -it ex-storage-empty-dir -- df -h /cache
Filesystem      Size  Used Avail Use% Mounted on
/dev/sdb        251G   17G  222G   8% /cache
----

==== Persistent Volume

[source,yaml]
----
apiVersion: v1
kind: PersistentVolume
metadata:
  name: ${PV_NAME}
spec:
  capacity:
    storage: 256Mi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: ""
  local:
    path: ${MOUNT_POINT}
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
            - ${KUBE_HOSTNAME}
----

[source,yaml]
.ex-storage-pv-local-pod.yaml
----
include::../kind/ex-storage-pv-local/ex-storage-pv-local-pod.yaml[]
----

. Make directory (KIND only)
+
[source,shell]
----
docker exec ${KUBE_NODENAME} mkdir -p ${MOUNT_POINT}
----

. Deploy
+
[source,shell]
----
kubectl apply -f ${WORK_DIR}/ex-storage-pv-local.yaml
kubectl apply -f ex-storage-pv-local-pod.yaml
----

. Delete
+
[source,shell]
----
kubectl delete -f ex-storage-pv-local-pod.yaml
kubectl delete persistentvolume ${PV_NAME}
----

. Delete directory (KIND only)
+
[source,shell]
----
docker exec ${KUBE_NODENAME} rmdir ${MOUNT_POINT}
----

=== Troubleshooting

* ip route
+
[source,console]
----
$ ip route
default via 172.31.160.1 dev eth0
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
172.18.0.0/16 dev br-cb34625844b6 proto kernel scope link src 172.18.0.1
172.31.160.0/20 dev eth0 proto kernel scope link src 172.31.169.105
----

** Show a specific route
+
[source,console]
----
$ ip route list 172.18.0.0/16
172.18.0.0/16 dev br-cb34625844b6 proto kernel scope link src 172.18.0.1
----

* arp +
Service に対する Endpoint が作成されていない場合は、 `HWaddress` の項目は `(incomplete)` になる
+
[source,console]
----
$ arp
Address                  HWtype  HWaddress           Flags Mask            Iface
172.18.0.2               ether   02:42:ac:12:00:02   C                     br-cb34625844b6
DESKTOP-E39V4F4          ether   00:15:5d:31:24:02   C                     eth0
172.18.254.240                   (incomplete)                              br-cb34625844b6
----

* arping
+
[source,console]
----
$ sudo arping 172.18.254.240 -c 3
ARPING 172.18.254.240
Timeout
Timeout
Timeout

--- 172.18.254.240 statistics ---
3 packets transmitted, 0 packets received, 100% unanswered (0 extra)
----

* Find ip
+
[source,console]
----
$ kubectl get services --all-namespaces | grep 172.18.254
default          go-hello-pod-metallb   LoadBalancer   10.96.17.114    172.18.254.240   8080:30161/TCP           22m
----

== References
